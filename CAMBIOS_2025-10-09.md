# Cambios Realizados - 9 de Octubre 2025

## 1. Restricción de Fecha Mínima para Reservas y Préstamos

### Objetivo
Los profesores deben hacer sus reservas y préstamos con **al menos 1 día de anticipación**. No pueden reservar/solicitar para el mismo día.

### Archivos Modificados

#### Reservas de Aulas
- **`app/controllers/ReservaController.php`** (líneas 42-54)
  - Validación backend: fecha debe ser >= mañana
  - Mensaje: "Solo puedes reservar a partir del día siguiente. Las reservas deben hacerse con anticipación, no el mismo día."

- **`app/view/Reserva.php`** (líneas 27-30)
  - Input date con `min="mañana"`
  
- **`Public/js/Reservas.js`** (líneas 65-75)
  - Validación JavaScript antes de enviar formulario
  - Alerta con SweetAlert2 si intenta reservar para hoy

#### Préstamos de Equipos
- **`app/models/PrestamoModel.php`**
  - `guardarPrestamosMultiple()` (líneas 16-24): Validación de fecha
  - `crearPrestamoPack()` (líneas 186-194): Validación de fecha para packs
  - Protección contra declaración múltiple con `if (!class_exists('PrestamoModel'))`

- **`app/view/Prestamo.php`** (líneas 88-92)
  - Fecha mínima establecida como mañana
  - Validación JavaScript (líneas 384-411)

- **`app/controllers/HistorialController.php`** (líneas 4-5)
  - Cambiado `require` a `require_once`

- **`app/controllers/DevolucionController.php`** (línea 4)
  - Cambiado `require` a `require_once`

---

## 2. Corrección de URLs de Notificaciones

### Objetivo
Las notificaciones deben redirigir correctamente según el tipo de usuario.

### Cambios en `app/controllers/ReservaController.php`
- Nueva reserva → Admin/Encargado: `Admin.php?view=historial_global`

### Cambios en `app/controllers/PrestamoController.php`
- Nuevo préstamo → Admin/Encargado: `Admin.php?view=historial_global`
- Nuevo pack → Admin/Encargado: `Admin.php?view=historial_global`
- Devolución → Docente: `Historial.php`
- Devolución → Admin: `Admin.php?view=devolucion`

---

## 3. Mejoras al Historial (Calendario) - Docente y Administrador

### Objetivo
Mejorar la interfaz del calendario y confirmar que muestra de lunes a sábado.

### Archivos Modificados

#### `app/view/Historial.php` (Docente)
**Cambios en la interfaz:**
- Reorganización de controles: botones Mañana/Tarde y PDF en la parte superior
- Botones de navegación (anterior/siguiente) centrados
- Nuevo badge que muestra el rango de fechas (ej: "15 oct - 20 oct")
- Texto descriptivo: "Semana de lunes a sábado"
- Botón PDF con color verde, icono y mejor posicionamiento
- Bootstrap Icons agregados

#### `app/view/HistorialGlobal.php` (Administrador)
**Cambios en la interfaz:**
- Reorganización de controles: botones Mañana/Tarde y PDF en la parte superior
- Botones de navegación (anterior/siguiente) centrados
- Nuevo badge que muestra el rango de fechas (ej: "15 oct - 20 oct")
- Texto descriptivo: "Semana de lunes a sábado"
- Botón PDF con color verde, icono y mejor posicionamiento
- Agregado Bootstrap Icons

#### `Public/js/Historial.js` (Docente)
**Nueva funcionalidad:**
- Función `updateWeekRangeDisplay()` que calcula y muestra el rango de fechas
- Se actualiza automáticamente al cambiar de semana
- Confirmación visual de que muestra 6 días (lunes a sábado)

#### `Public/js/HistorialGlobalCalendario.js` (Administrador)
**Nueva funcionalidad:**
- Función `updateWeekRangeDisplay()` que calcula y muestra el rango de fechas
- Se actualiza automáticamente al cambiar de semana
- Confirmación visual de que muestra 6 días (lunes a sábado)

#### `Public/css/historial.css` (Docente)
**Estilos agregados:**
- Estilo para `#week-range-display` (badge del rango de fechas)
- Botón PDF con gradiente verde y efecto hover
- Mejoras responsive para móviles

#### `Public/css/historial_global.css` (Administrador)
**Estilos agregados:**
- Estilo para `#week-range-display` (badge del rango de fechas)
- Botón PDF con gradiente verde y efecto hover
- Mejoras responsive para móviles (fuentes más pequeñas, espacios ajustados)

#### `app/controllers/HistorialController.php`
**Documentación mejorada:**
- Comentarios claros en `getWeekDates()` explicando que genera 6 días (lunes a sábado)

---

## 4. Corrección de Error de Clase Duplicada

### Problema
Error: "Cannot declare class PrestamoModel, because the name is already in use"

### Solución
- **`app/models/PrestamoModel.php`**: Agregada protección `if (!class_exists('PrestamoModel'))`
- **Controladores**: Cambiado `require` a `require_once` en todos los archivos que incluyen el modelo

---

## Resumen de Protecciones Implementadas

### Validación en Múltiples Capas

#### Para Reservas y Préstamos:
1. **HTML**: Input con atributo `min="mañana"`
2. **JavaScript**: Validación antes de enviar con mensaje amigable
3. **PHP Backend**: Validación final en modelo/controlador
4. **Zona horaria**: Configurada a `America/Lima` en todos los puntos

### Mensajes Consistentes
Todos los mensajes de error son claros y consistentes:
> "Solo puedes [reservar/solicitar préstamos] a partir del día siguiente. [Las reservas/Los préstamos] deben hacerse con anticipación, no el mismo día."

---

## Archivos Totales Modificados

1. `app/controllers/ReservaController.php`
2. `app/controllers/PrestamoController.php`
3. `app/controllers/HistorialController.php`
4. `app/controllers/DevolucionController.php`
5. `app/models/PrestamoModel.php`
6. `app/view/Reserva.php`
7. `app/view/Prestamo.php`
8. `app/view/Historial.php` (Docente)
9. `app/view/HistorialGlobal.php` (Administrador)
10. `Public/js/Reservas.js`
11. `Public/js/Historial.js` (Docente)
12. `Public/js/HistorialGlobalCalendario.js` (Administrador)
13. `Public/css/historial.css` (Docente)
14. `Public/css/historial_global.css` (Administrador)

---

## Notas Importantes

- ✅ El calendario siempre ha mostrado 6 días (lunes a sábado), ahora está mejor documentado
- ✅ Todas las validaciones de fecha usan la zona horaria de Perú (`America/Lima`)
- ✅ El sistema previene inclusiones múltiples de clases PHP
- ✅ Las notificaciones redirigen correctamente según el rol del usuario
- ✅ La interfaz es responsive y funciona bien en móviles

---

**Fecha de cambios:** 9 de Octubre, 2025  
**Desarrollador:** Cascade AI Assistant
